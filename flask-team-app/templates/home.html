<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Task Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  </head>

  <body>
    <div class="container">

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-wrap">
            {% for category, message in messages %}
              <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      {% include '_nav.html' %}

      <!-- Compact header -->
      <div class="card">
        <div class="cardBody" style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
          <div>
            <div style="font-weight:800; font-size:18px;">Dashboard</div>
            <div style="color:var(--muted); font-size:13px;">
              Track your tasks, set due dates, and stay on top of what’s next.
            </div>
          </div>

          <div class="stats">
            <span class="pill">Total: <b style="color:var(--text)">{{ total }}</b></span>
            <span class="pill">Complete: <b style="color:var(--text)">{{ complete }}</b></span>
            <span class="pill">Incomplete: <b style="color:var(--text)">{{ incomplete }}</b></span>
          </div>
        </div>
      </div>

      <!-- Main layout -->
      <div class="main">
        <!-- Tasks panel -->
        <div class="card">
          <div class="cardHeader">
            <div style="font-weight:800;">Your Tasks</div>

            <div class="headerRight">
              <!-- One form controls everything (Sort + Filters) -->
              <form method="GET" action="{{ url_for('home_page') }}" class="filterForm">
                <!-- Sort -->
                <div class="filterGroup">
                  <label class="sortLabel" for="sort">Sort</label>
                  <select id="sort" name="sort" class="sortSelect" onchange="this.form.submit()">
                    <option value="due_asc" {% if sort=='due_asc' %}selected{% endif %}>Due date (soonest)</option>
                    <option value="due_desc" {% if sort=='due_desc' %}selected{% endif %}>Due date (latest)</option>
                    <option value="newest" {% if sort=='newest' %}selected{% endif %}>Created (newest)</option>
                    <option value="oldest" {% if sort=='oldest' %}selected{% endif %}>Created (oldest)</option>
                    <option value="status" {% if sort=='status' %}selected{% endif %}>Status (incomplete first)</option>
                  </select>
                </div>

                <!-- Status -->
                <div class="filterGroup">
                  <label class="sortLabel" for="status">Status</label>
                  <select id="status" name="status" class="sortSelect">
                    <option value="all" {% if status_filter=='all' %}selected{% endif %}>All</option>
                    <option value="complete" {% if status_filter=='complete' %}selected{% endif %}>Complete</option>
                    <option value="incomplete" {% if status_filter=='incomplete' %}selected{% endif %}>Incomplete</option>
                  </select>
                </div>

                <!-- Search -->
                <div class="filterGroup filterSearch">
                  <label class="sortLabel" for="q">Search</label>
                  <input
                    id="q"
                    name="q"
                    value="{{ q }}"
                    placeholder="title or keyword..."
                    class="filterInput"
                    type="text"
                  />
                </div>

                <!-- Due exact -->
                <div class="filterGroup">
                  <label class="sortLabel" for="due">Due</label>
                  <input id="due" name="due" value="{{ due }}" type="date" class="filterInput filterDate" />
                </div>

                <!-- Due range -->
                <div class="filterGroup">
                  <label class="sortLabel" for="due_from">From</label>
                  <input id="due_from" name="due_from" value="{{ due_from }}" type="date" class="filterInput filterDate" />
                </div>

                <div class="filterGroup">
                  <label class="sortLabel" for="due_to">To</label>
                  <input id="due_to" name="due_to" value="{{ due_to }}" type="date" class="filterInput filterDate" />
                </div>

                <!-- Apply + Clear -->
                <button class="pill" type="submit" style="border:none;">Apply</button>

                <!-- Clear resets all filters but keeps sort -->
                <a class="pill" href="{{ url_for('home_page', sort=sort) }}" style="text-decoration:none;">Clear</a>
              </form>

              <div class="pill">Dashboard</div>
            </div>
          </div>

          <!-- Scroll happens here -->
          <div class="cardBody scrollArea">

            <!-- Active filters summary -->
            <div class="activeFilters">
              {% if active_filters and active_filters|length > 0 %}
                <span class="activeLabel">Active:</span>
                <span class="activeList">{{ active_filters | join(" • ") }}</span>
              {% else %}
                <span class="activeMuted">No active filters.</span>
              {% endif %}
              <span class="activeCount">Showing <b>{{ shown_count }}</b> task(s).</span>
            </div>

            <!-- Add task form -->
            <form method="POST" action="/tasks/add" style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; align-items:center;">
              <!-- preserve current filters across POST redirects -->
              <input type="hidden" name="sort" value="{{ sort }}"/>
              <input type="hidden" name="status" value="{{ status_filter }}"/>
              <input type="hidden" name="q" value="{{ q }}"/>
              <input type="hidden" name="due" value="{{ due }}"/>
              <input type="hidden" name="due_from" value="{{ due_from }}"/>
              <input type="hidden" name="due_to" value="{{ due_to }}"/>

              <input name="title" placeholder="Task title..." required
                     style="flex:1; min-width:220px; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04); color:var(--text);" />

              <input name="memo" placeholder="Optional memo..."
                     style="flex:2; min-width:260px; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04); color:var(--text);" />

              <!-- Due: now matches filter date picker styling -->
              <div style="display:flex; align-items:center; gap:8px;">
                <span class="sortLabel" style="min-width:28px;">Due</span>
                <input
                  name="due_date"
                  type="date"
                  aria-label="Due date"
                  class="filterInput filterDate"
                />
              </div>

              <button class="pill" type="submit" style="border:none;">Add</button>
            </form>

            {% if tasks and tasks|length > 0 %}
              {% for task in tasks %}
                <div class="task">
                  <div>
                    <p class="taskTitle">{{ task.title }}</p>
                    <div class="taskMeta">
                      {% if task.due_date %}
                        <span class="metaPill">Due: {{ task.due_date }}</span>
                      {% else %}
                        <span class="metaPill muted">No due date</span>
                      {% endif %}
                    </div>
                    {% if task.memo %}
                      <p class="taskMemo">{{ task.memo }}</p>
                    {% else %}
                      <p class="taskMemo"><em>No notes.</em></p>
                    {% endif %}
                  </div>

                  <div>
                    {% if task.status == "complete" %}
                      <span class="badge complete">Complete</span>
                    {% else %}
                      <span class="badge incomplete">Incomplete</span>
                    {% endif %}

                    <div class="taskActions">
                      <a class="pill" href="/tasks/{{ task.id }}" style="text-decoration:none;">View</a>

                      <form method="POST" action="/tasks/{{ task.id }}/toggle" style="margin:0;">
                        <input type="hidden" name="sort" value="{{ sort }}"/>
                        <input type="hidden" name="status" value="{{ status_filter }}"/>
                        <input type="hidden" name="q" value="{{ q }}"/>
                        <input type="hidden" name="due" value="{{ due }}"/>
                        <input type="hidden" name="due_from" value="{{ due_from }}"/>
                        <input type="hidden" name="due_to" value="{{ due_to }}"/>
                        <button class="pill" type="submit" style="border:none;">Toggle</button>
                      </form>

                      <form method="POST" action="/tasks/{{ task.id }}/delete" style="margin:0;" onsubmit="return confirm('Delete this task?');">
                        <input type="hidden" name="sort" value="{{ sort }}"/>
                        <input type="hidden" name="status" value="{{ status_filter }}"/>
                        <input type="hidden" name="q" value="{{ q }}"/>
                        <input type="hidden" name="due" value="{{ due }}"/>
                        <input type="hidden" name="due_from" value="{{ due_from }}"/>
                        <input type="hidden" name="due_to" value="{{ due_to }}"/>
                        <button class="pill" type="submit" style="border:none;">Delete</button>
                      </form>
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="empty">
                <b>No tasks found.</b><br/>
                Try clearing filters or add a new task.
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Right panel -->
        <div class="card">
          <div class="cardHeader">
            <div style="font-weight:800;">Today</div>
            <div class="pill">Your guide</div>
          </div>

          <div class="cardBody">
            <div class="miniSection">
              <div class="miniTitle">Next up</div>
              {% set ns = namespace(count=0) %}
              {% for t in tasks %}
                {% if (not t.completed) and t.due_date %}
                  {% if ns.count < 3 %}
                    <div class="miniRow">
                      <div class="miniLeft">
                        <div class="miniName">{{ t.title }}</div>
                        <div class="miniMeta">Due {{ t.due_date }}</div>
                      </div>
                      <a class="miniLink" href="{{ url_for('view_task', task_id=t.id) }}">View</a>
                    </div>
                    {% set ns.count = ns.count + 1 %}
                  {% endif %}
                {% endif %}
              {% endfor %}
              {% if ns.count == 0 %}
                <div class="empty" style="margin-top:8px;">
                  <b>No upcoming due dates.</b><br/>
                  Add a task and pick a due date to see it here.
                </div>
              {% endif %}
            </div>

            <div style="height:14px"></div>

            <div class="miniSection">
              <div class="miniTitle">Quick tips</div>
              <div class="tip">
                <b>Add tasks fast:</b> type a title, optionally add a memo, pick a due date, then hit <b>Add</b>.
              </div>
              <div class="tip">
                <b>Stay focused:</b> use <b>Sort</b> to show what’s due soon or bring incomplete tasks to the top.
              </div>
              <div class="tip">
                <b>Private by default:</b> your tasks are tied to your account — other users can’t see them.
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </body>
</html>